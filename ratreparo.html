<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RAT Reparo v14.0 - RL NET</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML2PDF -->
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');
        
        body { font-family: 'Roboto', sans-serif; background-color: #fff7ed; color: #334155; -webkit-tap-highlight-color: transparent; padding-bottom: 200px; }

        /* --- CORES --- */
        :root { --brand: #ea580c; --brand-light: #ffedd5; --brand-dark: #c2410c; }

        /* --- UI ELEMENTS --- */
        .block-container {
            background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 10px; overflow: hidden; border: 1px solid #e2e8f0;
        }
        .block-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: #fff; border-left: 4px solid #cbd5e1;
            cursor: pointer; user-select: none; transition: all 0.2s;
        }
        .block-header.active { border-left-color: var(--brand); background-color: #fffaf0; }
        .block-title { font-weight: 800; color: #1e293b; text-transform: uppercase; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .block-content { padding: 15px; border-top: 1px solid #f1f5f9; display: none; background-color: #fff; }
        .block-content.show { display: block; animation: slideDown 0.2s ease-out; }

        /* INPUTS */
        .input-label { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 3px; display: block; text-transform: uppercase; }
        .input-field {
            width: 100%; padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 4px;
            font-size: 13px; height: 34px; background-color: #fff; color: #0f172a; transition: all 0.2s;
        }
        .input-field:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.1); }
        .input-field.error { border-color: #ef4444; background-color: #fef2f2; }
        .input-field:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .uppercase-input { text-transform: uppercase; }

        /* CHECKLIST CARDS */
        .check-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; }
        .check-label { font-size: 0.8rem; font-weight: 600; color: #334155; display: flex; align-items: center; gap: 6px; }
        .check-select { width: 60px; height: 26px; font-size: 0.7rem; border-radius: 4px; border: 1px solid #cbd5e1; background: #f8fafc; text-align: center; font-weight: bold; }
        
        /* CHIPS */
        .chip-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip-label {
            display: inline-flex; align-items: center; padding: 6px 10px;
            background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600; color: #475569; cursor: pointer; transition: all 0.2s;
        }
        .chip-input:checked + .chip-label {
            background: var(--brand); color: white; border-color: var(--brand-dark);
            box-shadow: 0 2px 4px rgba(234, 88, 12, 0.25);
        }
        .chip-input { display: none; }

        /* DYNAMIC LISTS */
        .dynamic-list { margin-top: 5px; display: flex; flex-direction: column; gap: 4px; }
        .dynamic-item {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 6px 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;
        }
        .btn-remove { color: #ef4444; background: none; border: none; padding: 2px; }
        
        /* FEEDBACK RADIO GROUP */
        .fb-group { margin-bottom: 8px; background: #f8fafc; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .fb-title { font-size: 9px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .fb-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .fb-opt-label { font-size: 10px; display: flex; align-items: center; gap: 3px; cursor: pointer; color: #334155; }

        /* ASSINATURA */
        .sig-wrapper { margin-bottom: 10px; }
        .sig-box { 
            position: relative; width: 100%; height: 140px; 
            background: #fff; border: 2px dashed #cbd5e1; border-radius: 6px; 
            touch-action: none; cursor: crosshair; overflow: hidden;
        }
        .sig-placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #e2e8f0; font-size: 10px; pointer-events: none; user-select: none;
            text-transform: uppercase; font-weight: bold;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* NAV BTN */
        .btn-next {
            background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe;
            font-size: 11px; font-weight: 700; padding: 8px 16px; border-radius: 6px;
            display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;
            margin-top: 15px; width: 100%; justify-content: center;
        }
        .btn-next:hover { background-color: #dbeafe; }
        
        /* ALERTA */
        .save-indicator { position: fixed; top: 10px; right: 10px; font-size: 10px; color: #fff; background: #16a34a; padding: 4px 8px; border-radius: 12px; opacity: 0; transition: opacity 0.5s; z-index: 100; font-weight: bold; }
        .save-indicator.show { opacity: 1; }

        /* PDF MODE */
        .pdf-mode body { background: white; padding: 0; }
        .pdf-mode .no-print, .pdf-mode .footer-fixed, .pdf-mode .block-header, .pdf-mode .btn-next { display: none !important; }
        .pdf-mode .block-container { 
            border: none; box-shadow: none; margin-bottom: 15px; 
            border-bottom: 2px solid #eee; border-radius: 0; 
            break-inside: avoid; page-break-inside: avoid; 
        }
        .pdf-mode .block-header { 
            background: transparent !important; padding: 5px 0; border-left: none !important; 
            color: var(--brand); border-bottom: 1px solid var(--brand); display: flex !important; pointer-events: none; 
        }
        .pdf-mode .block-header i { display: none; }
        .pdf-mode .block-content { display: block !important; padding: 5px 0; border: none; }
        .pdf-mode .input-field { border: 1px solid #ddd; background: #fff !important; height: auto; min-height: 20px; padding: 1px 4px; font-size: 9pt; }
        .pdf-hide-empty:empty { display: none; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="save_indicator" class="save-indicator"><i class="fas fa-check"></i> Salvo</div>

    <!-- DATALIST OPERADORES -->
    <datalist id="lista_operadores">
        <option value="BRUNO GOULART"><option value="KETLIN SANTOS"><option value="EDGAR MELO">
        <option value="JULIANO ABREU"><option value="FILIPE CRUZ"><option value="MATHEUS ECHELI">
        <option value="IGOR AGUIAR"><option value="THOMAS MAGNUN"><option value="VÍTOR NOBRE">
        <option value="TUANI SERINI"><option value="GABRIEL OLIVEIRA"><option value="BRUNO VAZ">
    </datalist>

    <!-- HEADER -->
    <div class="bg-white border-b border-orange-200 sticky top-0 z-40 px-4 py-3 shadow-sm flex justify-between items-center no-print">
        <div class="flex items-center gap-2">
            <!-- LOGO RL NET ATUALIZADO -->
            <img src="https://i.imgur.com/qndtfM0.png" class="h-10 w-auto object-contain mr-2" alt="Logo RL NET" crossorigin="anonymous">
            <h1 class="font-bold text-slate-800 text-sm leading-tight">RAT REPARO <br><span class="text-[10px] text-orange-600">v1.0 | Dev. Filipe Cruz</span></h1>
        </div>
        <div class="flex gap-2">
		<a href="index.html" class="text-[10px] font-bold text-blue-500 border border-blue-200 bg-blue-50 px-3 py-1.5 rounded hover:bg-blue-100 flex items-center gap-1 no-underline">
    <i class="fas fa-home"></i> INÍCIO
</a>
            <button onclick="confirmarNovo()" class="text-[10px] font-bold text-red-500 border border-red-200 bg-red-50 px-3 py-1.5 rounded hover:bg-red-100">
                <i class="fas fa-trash"></i> LIMPAR
            </button>
        </div>
    </div>

    <!-- LOGO FOR PDF (Hidden on Screen) -->
    <div id="pdf-header-logo" class="hidden flex items-center justify-between mb-4 border-b pb-2">
        <img src="https://i.imgur.com/qndtfM0.png" class="h-12 w-auto" alt="Logo">
        <div class="text-right">
            <h1 class="font-bold text-lg text-slate-800">RAT DE REPARO</h1>
            <p class="text-xs text-gray-500">Relatório Técnico Digital</p>
        </div>
    </div>

    <div id="rat-content" class="max-w-2xl mx-auto p-3">

        <!-- 1. IDENTIFICAÇÃO -->
        <div class="block-container" id="blk_1">
            <div class="block-header active" onclick="toggleBlock('blk_1')">
                <span class="block-title"><i class="fas fa-id-card text-orange-600"></i> 1. IDENTIFICAÇÃO <span class="text-red-500 ml-1">*</span></span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content show">
                <div class="grid grid-cols-12 gap-2 mb-3">
                    <div class="col-span-3"><label class="input-label">ID O.S <span class="text-red-500">*</span></label><input type="number" id="os_id" class="input-field font-bold bg-orange-50 text-center required-field" placeholder="0000"></div>
                    <div class="col-span-3"><label class="input-label">ID CLI <span class="text-red-500">*</span></label><input type="number" id="cli_id" class="input-field font-bold text-center required-field" placeholder="0000"></div>
                    <div class="col-span-6"><label class="input-label">CLIENTE <span class="text-red-500">*</span></label><input type="text" id="cli_nome" class="input-field uppercase-input required-field" placeholder="NOME COMPLETO"></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="input-label">DATA <span class="text-red-500">*</span></label><input type="date" id="data_exec" class="input-field px-1 text-center text-xs required-field"></div>
                    <div><label class="input-label">ENTRADA <span class="text-red-500">*</span></label><input type="time" id="hora_in" class="input-field px-1 text-center text-xs required-field"></div>
                    <div><label class="input-label">SAÍDA <span class="text-red-500">*</span></label><input type="time" id="hora_out" class="input-field px-1 text-center text-xs required-field"></div>
                </div>
                <!-- Nav Button -->
                <button class="btn-next" onclick="nextBlock('blk_1', 'blk_2')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 2. ANÁLISE TÉCNICA -->
        <div class="block-container" id="blk_2">
            <div class="block-header" onclick="toggleBlock('blk_2')">
                <span class="block-title"><i class="fas fa-stethoscope text-orange-600"></i> 2. ANÁLISE TÉCNICA <span class="text-red-500 ml-1">*</span></span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <div class="grid md:grid-cols-2 gap-4">
                    <div id="group_equip">
                        <div class="flex justify-between items-center border-b border-orange-100 mb-2">
                            <h4 class="text-[10px] font-bold text-orange-600 uppercase">Equipamentos & Interno</h4>
                            <label class="text-[9px] flex items-center gap-1 text-gray-500"><input type="checkbox" onchange="toggleNaoVerificado('group_equip', this)"> Não verificado</label>
                        </div>
                        <div class="space-y-1">
                            <div class="check-row"><span class="check-label"><i class="fas fa-hard-hat text-gray-400 w-4"></i> Segurança</span> <select id="chk_seg" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-plug text-gray-400 w-4"></i> Fontes</span> <select id="chk_fontes" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-server text-gray-400 w-4"></i> ONU/ONT</span> <select id="chk_onu" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-wifi text-gray-400 w-4"></i> Roteador</span> <select id="chk_router" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-tv text-gray-400 w-4"></i> TV Box</span> <select id="chk_tvbox" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-video text-gray-400 w-4"></i> Câmera</span> <select id="chk_camera" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-laptop-house text-gray-400 w-4"></i> Rede UTP</span> <select id="chk_utp" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-paint-roller text-gray-400 w-4"></i> Acab. Interno</span> <select id="chk_acabamento" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                        </div>
                    </div>
                    <div id="group_rede">
                        <div class="flex justify-between items-center border-b border-blue-100 mb-2">
                            <h4 class="text-[10px] font-bold text-blue-600 uppercase">Rede & Testes</h4>
                            <label class="text-[9px] flex items-center gap-1 text-gray-500"><input type="checkbox" onchange="toggleNaoVerificado('group_rede', this)"> Não verificado</label>
                        </div>
                        <div class="space-y-1">
                            <div class="check-row"><span class="check-label"><i class="fas fa-network-wired text-gray-400 w-4"></i> Configs</span> <select id="chk_config" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-route text-gray-400 w-4"></i> Drop Ext.</span> <select id="chk_drop" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-ethernet text-gray-400 w-4"></i> Conector</span> <select id="chk_conec" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-link text-gray-400 w-4"></i> Emenda Mec.</span> <select id="chk_emenda" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-signal text-gray-400 w-4"></i> Alcance Wi-Fi</span> <select id="chk_alcance" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-satellite-dish text-gray-400 w-4"></i> IPTV</span> <select id="chk_iptv" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-box text-gray-400 w-4"></i> Acab. Externo</span> <select id="chk_acab_ext" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                            <div class="check-row"><span class="check-label"><i class="fas fa-tachometer-alt text-gray-400 w-4"></i> Teste Vel.</span> <select id="chk_teste" class="check-select required-select"><option value="" selected disabled>-</option><option>OK</option><option>NOK</option><option>N/A</option></select></div>
                        </div>
                    </div>
                </div>
                <div class="mt-3"><input type="text" id="analise_obs" class="input-field text-xs bg-gray-50" placeholder="Observações da Análise..."></div>
                <button class="btn-next" onclick="nextBlock('blk_2', 'blk_3')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 3. PROCEDIMENTOS -->
        <div class="block-container" id="blk_3">
            <div class="block-header" onclick="toggleBlock('blk_3')">
                <span class="block-title"><i class="fas fa-tools text-orange-600"></i> 3. PROCEDIMENTOS <span class="text-red-500 ml-1">*</span></span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Infra, Emendas e Conectores</p>
                <div class="chip-grid mb-4">
                    <label><input type="checkbox" class="chip-input" value="conector externo"><span class="chip-label">Conector Externo</span></label>
                    <label><input type="checkbox" class="chip-input" value="conector interno"><span class="chip-label">Conector Interno</span></label>
                    <label><input type="checkbox" class="chip-input" value="conector na emenda"><span class="chip-label">Conector na Emenda</span></label>
                    <label><input type="checkbox" class="chip-input" value="conectores rj45"><span class="chip-label">Conectores RJ45</span></label>
                    <label><input type="checkbox" class="chip-input" value="acoplador externo"><span class="chip-label">Acoplador Externo</span></label>
                    <label><input type="checkbox" class="chip-input" value="acoplador ONU"><span class="chip-label">Acoplador ONU</span></label>
                    <label><input type="checkbox" class="chip-input" value="adição de emenda"><span class="chip-label">Adição de Emenda</span></label>
                    <label><input type="checkbox" class="chip-input" value="remoção de emenda"><span class="chip-label">Remoção de Emenda</span></label>
                    <label><input type="checkbox" class="chip-input" value="emenda mantida"><span class="chip-label">Emenda Mantida</span></label>
                </div>
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Drop e Cabeamento</p>
                <div class="chip-grid mb-4">
                    <label><input type="checkbox" class="chip-input" value="problema de infra"><span class="chip-label">Problema de Infra</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca completo de drop"><span class="chip-label">Troca Drop Completo</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca parcial de drop"><span class="chip-label">Troca Drop Parcial</span></label>
                    <label><input type="checkbox" class="chip-input" value="adequação de drop"><span class="chip-label">Adequação de Drop</span></label>
                    <label><input type="checkbox" class="chip-input" value="cabo utp trocado"><span class="chip-label">Cabo UTP Trocado</span></label>
                    <label><input type="checkbox" class="chip-input" value="cabo utp lançado"><span class="chip-label">Cabo UTP Lançado</span></label>
                </div>
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Equipamentos e Serviços</p>
                <div class="chip-grid mb-4">
                    <label><input type="checkbox" class="chip-input" value="troca de onu"><span class="chip-label">Troca de ONU</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca de ONT"><span class="chip-label">Troca de ONT</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca de roteador"><span class="chip-label">Troca de Roteador</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca de fonte"><span class="chip-label">Troca de Fonte</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca de câmera"><span class="chip-label">Troca de Câmera</span></label>
                    <label><input type="checkbox" class="chip-input" value="troca de tv box"><span class="chip-label">Troca de TV Box</span></label>
                    <label><input type="checkbox" class="chip-input" value="outros equipamentos"><span class="chip-label">Outros Equipamentos</span></label>
                    <label><input type="checkbox" class="chip-input" value="configs e testes"><span class="chip-label">Configs e Testes</span></label>
                    <label><input type="checkbox" class="chip-input" value="instalação de apps"><span class="chip-label">Instalação de Apps</span></label>
                    <label><input type="checkbox" class="chip-input" value="orientação ao cliente"><span class="chip-label">Orientação ao Cliente</span></label>
                    <label><input type="checkbox" class="chip-input" value="improdutiva"><span class="chip-label">Improdutiva</span></label>
                    <label><input type="checkbox" class="chip-input" value="outros"><span class="chip-label">Outros</span></label>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-2 mt-2">
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-bold text-yellow-800 flex items-center gap-2"><input type="checkbox" id="cobrar_taxa" onchange="document.getElementById('area_valor').classList.toggle('hidden')"> COBRAR TAXA DE VISITA?</label>
                    </div>
                    <div id="area_valor" class="hidden mt-2 grid grid-cols-2 gap-2">
                        <input type="tel" id="taxa_valor" class="input-field text-sm font-mono text-center" placeholder="R$ 0,00" oninput="mascaraMoeda(this)">
                        <select id="taxa_forma" class="input-field text-sm"><option value="">Forma...</option><option>Boleto</option><option>PIX</option><option>Dinheiro</option><option>Crédito</option><option>Débito</option><option>Suporte Ciente</option></select>
                    </div>
                </div>
                <button class="btn-next" onclick="nextBlock('blk_3', 'blk_4')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 4. POTÊNCIA E INFRA -->
        <div class="block-container" id="blk_4">
            <div class="block-header" onclick="toggleBlock('blk_4')">
                <span class="block-title"><i class="fas fa-bolt text-orange-600"></i> 4. POTÊNCIA E INFRA</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <div class="flex justify-between items-center mb-1"><label class="input-label">Nº CTO</label><label class="text-[9px] flex items-center gap-1 text-gray-500"><input type="checkbox" id="cto_sem_id" onchange="toggleCTO(this)"> Sem ID</label></div>
                        <input type="number" id="cto_num" class="input-field font-bold">
                    </div>
                    <div>
                        <label class="input-label">PORTA</label>
                        <select id="cto_porta" class="input-field font-mono text-center"><option value="">-</option><script>for(let i=1;i<=16;i++) document.write(`<option value="${i}">${i}</option>`);</script></select>
                    </div>
                </div>
                <div class="bg-gray-50 p-2 rounded border border-gray-200 mb-3 relative">
                    <p class="text-[9px] font-bold text-center text-gray-500 mb-2">LEITURAS DE POTÊNCIA (DBM)</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-gray-500 text-center mb-1">CTO</label><input type="tel" id="pot_cto" class="input-field text-center font-mono text-sm tracking-tight" placeholder="-00,00" oninput="maskDBM(this); checkPower()"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-gray-500 text-center mb-1">DROP</label><input type="tel" id="pot_drop" class="input-field text-center font-mono text-sm font-bold text-green-700 tracking-tight" placeholder="-00,00" oninput="maskDBM(this); checkPower()"></div>
<div class="flex flex-col">
    <label class="text-[9px] font-bold text-gray-500 text-center mb-1">IXC <span class="text-red-500">*</span></label>
<input type="tel" id="pot_ixc" class="input-field text-center font-mono text-sm tracking-tight required-field" placeholder="-00,00" oninput="maskDBM(this); checkPower()">
</div>                    </div>
                    <div id="power_alert" class="hidden mt-2 p-1.5 rounded text-[10px] font-bold text-center border"></div>
                </div>
                <div class="mb-4 space-y-2 bg-white border rounded p-2 text-xs">
                    <div class="flex flex-col gap-1 pb-2 border-b border-dashed">
                        <span class="font-bold text-gray-600">CTO Batida?</span>
                        <div class="flex gap-2 items-center">
                            <label><input type="radio" name="oc_cto_batida" value="Nao" checked onclick="document.getElementById('op_batida').classList.add('hidden')"> Não</label>
                            <label><input type="radio" name="oc_cto_batida" value="Sim" onclick="document.getElementById('op_batida').classList.remove('hidden')"> Sim</label>
                            <input type="text" id="op_batida" class="hidden border-b border-gray-300 w-full text-xs uppercase-input" list="lista_operadores" placeholder="Operador...">
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 pb-2 border-b border-dashed">
                        <span class="font-bold text-gray-600">ID Removido?</span>
                        <div class="flex gap-2 items-center flex-wrap">
                            <label><input type="radio" name="oc_id_rem" value="Nao" checked onclick="document.getElementById('area_id_rem').classList.add('hidden')"> Não</label>
                            <label><input type="radio" name="oc_id_rem" value="Sim" onclick="document.getElementById('area_id_rem').classList.remove('hidden')"> Sim</label>
                            <div id="area_id_rem" class="hidden flex gap-2 items-center w-full">
                                <input type="number" id="id_removido" class="border p-1 w-20 text-center" placeholder="ID Antigo">
                                <label class="text-[9px]"><input type="checkbox" id="id_rem_null"> Sem ID</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-gray-600">1x2 Adicionado?</span>
                        <div class="flex gap-2 items-center">
                            <label><input type="radio" name="oc_split" value="Nao" checked onclick="document.getElementById('area_split').classList.add('hidden')"> Não</label>
                            <label><input type="radio" name="oc_split" value="Sim" onclick="document.getElementById('area_split').classList.remove('hidden')"> Sim</label>
                        </div>
                        <div id="area_split" class="hidden grid grid-cols-2 gap-2 mt-1">
                            <input type="text" id="split_auth" class="border p-1 text-xs uppercase-input" list="lista_operadores" placeholder="Autorizado por...">
                            <input type="number" id="split_id" class="border p-1 text-xs text-center" placeholder="ID usado">
                        </div>
                    </div>
                </div>
                <button class="btn-next" onclick="nextBlock('blk_4', 'blk_5')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 5. MATERIAIS E CABOS -->
        <div class="block-container" id="blk_5">
            <div class="block-header" onclick="toggleBlock('blk_5')">
                <span class="block-title"><i class="fas fa-box-open text-orange-600"></i> 5. MATERIAIS E CABOS</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
               <div class="bg-orange-50 p-2 rounded border border-orange-100 mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <h5 class="text-[10px] font-bold text-orange-800">CABO DROP</h5>
                        <label class="text-[9px] flex items-center gap-1 text-gray-600 font-bold"><input type="checkbox" id="drop_nao_usado" onchange="toggleCabo('drop', this)"> Não utilizado</label>
                    </div>
                    <input type="text" id="drop_id" class="input-field h-7 text-xs mb-1" placeholder="ID Bobina">
                    <div class="flex gap-2 items-end">
                        <div class="flex-1"><label class="text-[9px]">INICIAL (m) <span class="text-red-500">*</span></label><input type="number" id="drop_ini" class="input-field h-8 text-xs"></div>
                        <div class="flex-1"><label class="text-[9px]">FINAL (m) <span class="text-red-500">*</span></label><input type="number" id="drop_fim" class="input-field h-8 text-xs" oninput="calcCabo('drop')"></div>
                        <div class="w-16"><label class="text-[9px] font-bold text-green-700">TOTAL</label><input type="text" id="drop_total" readonly class="input-field h-8 text-xs font-bold bg-green-50 text-center border-green-200" value="0m"></div>
                    </div>
                </div>

                <div class="bg-blue-50 p-2 rounded border border-blue-100 mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <h5 class="text-[10px] font-bold text-blue-800">CABO UTP (REDE)</h5>
                        <label class="text-[9px] flex items-center gap-1 text-gray-600 font-bold"><input type="checkbox" id="utp_nao_usado" onchange="toggleCabo('utp', this)"> Não utilizado</label>
                    </div>
                    <input type="text" id="utp_id" class="input-field h-7 text-xs mb-1" placeholder="ID Bobina">
                    <div class="flex gap-2 items-end">
                        <div class="flex-1"><label class="text-[9px]">INICIAL (m) <span class="text-red-500">*</span></label><input type="number" id="utp_ini" class="input-field h-8 text-xs"></div>
                        <div class="flex-1"><label class="text-[9px]">FINAL (m) <span class="text-red-500">*</span></label><input type="number" id="utp_fim" class="input-field h-8 text-xs" oninput="calcCabo('utp')"></div>
                        <div class="w-16"><label class="text-[9px] font-bold text-green-700">TOTAL</label><input type="text" id="utp_total" readonly class="input-field h-8 text-xs font-bold bg-green-50 text-center border-green-200" value="0m"></div>
                    </div>
                </div>
                <div class="border-t pt-2">
                    <p class="text-[10px] font-bold uppercase text-gray-500 mb-2">Movimentação de Materiais</p>
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 no-print">
                        <select id="mat_item" class="input-field h-8 text-xs mb-2">
                            <option value="">Selecione o Item...</option>
                            <optgroup label="Roteadores"><option>Huawei WS5200</option><option>Huawei Ax2</option><option>Huawei Ax3</option><option>TP Link G5</option><option>TP Link Ex141</option><option>TP Link xx230v</option><option>Intelbras</option><option>Tenda</option><option>ZTE H199A</option><option>ZTE EC2320</option><option>ZTE H196A</option><option>Outros</option></optgroup>
                            <optgroup label="ONT"><option>TP Link xx530v</option><option>ZTE F600P</option><option>ZTE F8</option><option>Huawei Coporativo</option><option>Sumec Integrado</option><option>Outros</option></optgroup>
                            <optgroup label="ONU"><option>ZTE</option><option>Huawei</option><option>Tenda</option><option>Sumec</option><option>Intelbras</option><option>Fiberhome</option><option>Elsys</option><option>Outros</option></optgroup>
                            <optgroup label="Acessórios/Outros"><option>Fast Conector</option><option>RJ45</option><option>RJ11</option><option>Acoplador</option><option>Fonte</option><option>Switch</option><option>TV Box</option><option>Câmera</option><option>Telefone Fixo</option><option>ATA</option><option>Router Board</option><option>Alça Preformada</option><option>Protetor de emenda</option><option>Outros</option></optgroup>
                        </select>
                        <div class="flex gap-2 mb-2">
                             <select id="mat_acao" class="input-field h-8 text-xs flex-1"><option value="Instalado">Instalado</option><option value="Retirado">Retirado</option></select>
                            <input type="number" id="mat_qtd" value="1" class="input-field h-8 text-xs w-16 text-center" placeholder="Qtd">
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="mat_motivo" class="input-field h-8 text-xs flex-1 uppercase-input" placeholder="Motivo...">
                            <button onclick="addMaterial()" class="bg-green-600 text-white rounded w-10 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="mat_list" class="dynamic-list"></div>
                </div>
                <button class="btn-next" onclick="nextBlock('blk_5', 'blk_6')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 6. APPS E SERVIÇOS -->
        <div class="block-container" id="blk_6">
            <div class="block-header" onclick="toggleBlock('blk_6')">
                <span class="block-title"><i class="fas fa-mobile-alt text-orange-600"></i> 6. APPS E SERVIÇOS RELACIONADOS</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-3" id="apps_list">
                    <!-- Apps Gerados via JS -->
                </div>
                <textarea id="apps_obs_geral" class="input-field h-12 text-xs" placeholder="Detalhes e observações dos Apps..."></textarea>
                <button class="btn-next" onclick="nextBlock('blk_6', 'blk_7')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 7. FEEDBACK DO SERVIÇO -->
        <div class="block-container" id="blk_7">
            <div class="block-header" onclick="toggleBlock('blk_7')">
                <span class="block-title"><i class="fas fa-bullhorn text-orange-600"></i> 7. FEEDBACK DO SERVIÇO</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="fb-group">
                        <span class="fb-title">Postura do Cliente</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_postura" value="Calmo"> Calmo</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_postura" value="Leigo"> Leigo</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_postura" value="Atritado"> Atritado</label>
                        </div>
                    </div>
                    <div class="fb-group">
                        <span class="fb-title">Instalação Pré-Reparo</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_inst" value="Péssimo"> Péssimo</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_inst" value="Ruim"> Ruim</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_inst" value="Aceitável"> Aceitável</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_inst" value="Bom"> Bom</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_inst" value="Excelente"> Excelente</label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="fb-group">
                        <span class="fb-title">Dificuldade</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_dificuldade" value="Difícil"> Difícil</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_dificuldade" value="Média"> Média</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_dificuldade" value="Fácil"> Fácil</label>
                        </div>
                    </div>
                     <div class="fb-group">
                        <span class="fb-title">Impacto da Infra</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_infra" value="Muito"> Muito</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_infra" value="Um Pouco"> Um Pouco</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_infra" value="Infra OK"> Infra OK</label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="fb-group">
                        <span class="fb-title">Qualidade Materiais</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_mat" value="Péssimo"> Péssimo</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_mat" value="Ruim"> Ruim</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_mat" value="Aceitável"> Aceitável</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_mat" value="Bom"> Bom</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_qual_mat" value="Excelente"> Excelente</label>
                        </div>
                    </div>
                    <div class="fb-group">
                        <span class="fb-title">Qualidade Ferramentas</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_ferramentas" value="Atrasou"> Atrasou</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_ferramentas" value="Indiferente"> Indiferente</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_ferramentas" value="Ajudou"> Ajudou</label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="fb-group">
                        <span class="fb-title">Qualidade Suporte</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_sup" value="Não Resolveu"> Não Resolveu</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_sup" value="Lento"> Lento</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_sup" value="Ajudou Muito"> Ajudou Muito</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_sup" value="N/A"> N/A</label>
                        </div>
                    </div>
                    <div class="fb-group">
                        <span class="fb-title">Suporte Supervisão</span>
                        <div class="fb-options">
                            <label class="fb-opt-label"><input type="radio" name="fb_super" value="Não Ajudou"> Não Ajudou</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_super" value="Sem Resposta"> Sem Resposta</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_super" value="Ajudou"> Ajudou</label>
                            <label class="fb-opt-label"><input type="radio" name="fb_super" value="N/A"> N/A</label>
                        </div>
                    </div>
                </div>
                <textarea id="obs_geral" class="input-field h-20" placeholder="Comentários adicionais sobre o serviço..."></textarea>
                <button class="btn-next" onclick="nextBlock('blk_7', 'blk_8')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 8. CHECAGEM DE FOTOS (LISTA FIXA) -->
        <div class="block-container" id="blk_8">
            <div class="block-header" onclick="toggleBlock('blk_8')">
                <span class="block-title"><i class="fas fa-camera text-orange-600"></i> 8. CHECAGEM DE FOTOS</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <div class="chip-grid">
                    <label class="chip-label bg-orange-50 border-orange-200 text-orange-900"><input type="checkbox" class="mr-1 accent-orange-600" value="PANORAMA CTO"> PANORAMA CTO</label>
                    <label class="chip-label bg-orange-50 border-orange-200 text-orange-900"><input type="checkbox" class="mr-1 accent-orange-600" value="PANORAMA CABO DROP"> PANORAMA CABO DROP</label>
                    <label class="chip-label bg-orange-50 border-orange-200 text-orange-900"><input type="checkbox" class="mr-1 accent-orange-600" value="PANORAMA ACABAMENTOS"> PANORAMA ACABAMENTOS</label>
                    <label class="chip-label bg-orange-50 border-orange-200 text-orange-900"><input type="checkbox" class="mr-1 accent-orange-600" value="BATERIA DE TESTES"> BATERIA DE TESTES</label>
                    <label class="chip-label bg-orange-50 border-orange-200 text-orange-900"><input type="checkbox" class="mr-1 accent-orange-600" value="PANORAMA SVAS"> PANORAMA SVAS</label>
                    <label class="chip-label bg-orange-50 border-orange-200 text-orange-900"><input type="checkbox" class="mr-1 accent-orange-600" value="PANORAMA UTP"> PANORAMA UTP</label>
                </div>
                <button class="btn-next" onclick="nextBlock('blk_8', 'blk_9')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 9. BATERIA DE TESTES -->
        <div class="block-container" id="blk_9">
            <div class="block-header" onclick="toggleBlock('blk_9')">
                <span class="block-title"><i class="fas fa-vial text-orange-600"></i> 9. BATERIA DE TESTES</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- A) WI-FI CARD -->
                    <div id="sub_wifi" class="border rounded-lg p-3 bg-slate-50 relative">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-200">
                            <h4 class="text-xs font-black text-blue-600 uppercase flex items-center gap-2"><i class="fas fa-wifi"></i> A) WI-FI</h4>
                            <label class="text-[10px] font-bold text-gray-500 cursor-pointer select-none bg-white px-2 py-1 rounded border border-gray-200 shadow-sm hover:bg-gray-50"><input type="checkbox" class="accent-red-500 mr-1" onchange="toggleTestes('sub_wifi', this)"> NÃO REALIZADO</label>
                        </div>
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1"><label class="text-[9px] font-bold text-gray-500 uppercase">Mapa de Sinal</label><button onclick="addWifiRow()" class="text-[9px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold hover:bg-blue-200 transition">+ Cômodo</button></div>
                            <div id="wifi_list" class="dynamic-list"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div><label class="text-[9px] font-bold text-gray-500 block mb-0.5">SITE TESTE</label><select id="wifi_site" class="input-field w-full"><option value="">Selecione...</option><option>Fast.com</option><option>Speedtest</option><option>Minha Conexão</option></select></div>
                            <div><label class="text-[9px] font-bold text-gray-500 block mb-0.5">DOWNLOAD</label><input type="text" id="wifi_dl" class="input-field w-full text-center font-mono font-bold text-blue-600" placeholder="Mb"></div>
                            <div><label class="text-[9px] font-bold text-gray-500 block mb-0.5">UPLOAD</label><input type="text" id="wifi_ul" class="input-field w-full text-center font-mono font-bold text-green-600" placeholder="Mb"></div>
                        </div>
                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-gray-500 block mb-1">LATÊNCIA (PING MS)</label>
                            <div class="grid grid-cols-4 gap-1">
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-gray-400 font-bold">GGL</span><input type="number" id="wifi_ping_goog" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-gray-400 font-bold">FCB</span><input type="number" id="wifi_ping_face" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-gray-400 font-bold">X</span><input type="number" id="wifi_ping_x" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-orange-400 font-bold">DNS</span><input type="number" id="wifi_ping_dns" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-gray-500 block mb-1">TESTE IPV6</label>
                            <div class="flex gap-2">
                                <select id="wifi_ipv6_nota" class="input-field w-16 text-center font-bold" onchange="checkIpv6('wifi')"><option value="10">10</option><option value="9">9</option><option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option><option value="0">0</option></select>
                                <input type="text" id="wifi_ipv6_detalhe" class="hidden input-field flex-1 text-red-600 bg-red-50 border-red-200" placeholder="Detalhe o problema...">
                            </div>
                        </div>
                    </div>
                    <!-- B) CABO CARD -->
                    <div id="sub_cabo" class="border rounded-lg p-3 bg-slate-50 relative">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-200">
                            <h4 class="text-xs font-black text-orange-600 uppercase flex items-center gap-2"><i class="fas fa-network-wired"></i> B) CABO</h4>
                            <label class="text-[10px] font-bold text-gray-500 cursor-pointer select-none bg-white px-2 py-1 rounded border border-gray-200 shadow-sm hover:bg-gray-50"><input type="checkbox" class="accent-red-500 mr-1" onchange="toggleTestes('sub_cabo', this)"> NÃO REALIZADO</label>
                        </div>
                        <div class="h-[26px] mb-3 hidden md:block"></div> 
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div><label class="text-[9px] font-bold text-gray-500 block mb-0.5">SITE TESTE</label><select id="cabo_site" class="input-field w-full"><option value="">Selecione...</option><option>Fast.com</option><option>Speedtest</option><option>Minha Conexão</option></select></div>
                            <div><label class="text-[9px] font-bold text-gray-500 block mb-0.5">DOWNLOAD</label><input type="text" id="cabo_dl" class="input-field w-full text-center font-mono font-bold text-blue-600" placeholder="Mb"></div>
                            <div><label class="text-[9px] font-bold text-gray-500 block mb-0.5">UPLOAD</label><input type="text" id="cabo_ul" class="input-field w-full text-center font-mono font-bold text-green-600" placeholder="Mb"></div>
                        </div>
                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-gray-500 block mb-1">LATÊNCIA (PING MS)</label>
                            <div class="grid grid-cols-4 gap-1">
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-gray-400 font-bold">GGL</span><input type="number" id="cabo_ping_goog" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-gray-400 font-bold">FCB</span><input type="number" id="cabo_ping_face" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-gray-400 font-bold">X</span><input type="number" id="cabo_ping_x" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                                <div class="relative"><span class="absolute top-1 left-1 text-[8px] text-orange-400 font-bold">DNS</span><input type="number" id="cabo_ping_dns" class="input-field w-full text-center pt-3 font-mono" placeholder="-"></div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-gray-500 block mb-1">TESTE IPV6</label>
                            <div class="flex gap-2">
                                <select id="cabo_ipv6_nota" class="input-field w-16 text-center font-bold" onchange="checkIpv6('cabo')"><option value="10">10</option><option value="9">9</option><option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option><option value="0">0</option></select>
                                <input type="text" id="cabo_ipv6_detalhe" class="hidden input-field flex-1 text-red-600 bg-red-50 border-red-200" placeholder="Detalhe o problema...">
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-next" onclick="nextBlock('blk_9', 'blk_10')">PRÓXIMO <i class="fas fa-arrow-down"></i></button>
            </div>
        </div>

        <!-- 10. FECHAMENTO -->
        <div class="block-container" id="blk_10">
            <div class="block-header" onclick="toggleBlock('blk_10')">
                <span class="block-title"><i class="fas fa-file-signature text-orange-600"></i> 10. FECHAMENTO</span>
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
            <div class="block-content">
                
                <div class="mb-4">
                    <label class="input-label">DETALHES ADICIONAIS DO SERVIÇO</label>
<textarea id="fechamento_obs" class="input-field h-20 mb-3 required-field" placeholder="Descreva aqui detalhes adicionais do serviço..."></textarea>                </div>

                <div class="mb-5 border-t pt-4">
                    <label class="input-label mb-2 text-base">ASSINATURA DO TÉCNICO</label>
                    <div class="flex flex-col gap-2">
<div class="flex flex-col gap-2">
                        <input type="text" id="tec_nome" list="lista_tecnicos" 
                               class="input-field text-sm font-bold text-orange-900 mb-2 h-10 required-field uppercase-input" 
                               placeholder="DIGITE OU SELECIONE O TÉCNICO..." 
                               onchange="this.value = this.value.toUpperCase()">
                        
                        <datalist id="lista_tecnicos">
                            <option value="ADRIANO SILVA">
                            <option value="ANDRÉ LUIS">
                            <option value="BRUNO COSTA">
                            <option value="CARLOS SILVA">
                            <option value="CLEITON SANTOS">
                            <option value="DIEGO SILVA">
                            <option value="ANDRÉ MORRUDO">
                            <option value="FAGNER JUDES">
                            <option value="FILIPE ALVES">
                            <option value="DAVID SALVALAIO">
                            <option value="ROVER REBIMBAS">
                            <option value="WILLIAM CRUZ">
                            <option value="EVERSON LEANDRO">
                            <option value="GENESIO QUADROS">
                            <option value="GIOVANNI MEIRA">
                            <option value="GUILHERME VITOR">
                            <option value="HARYEL FORTES">
                            <option value="JADER BECK">
                            <option value="JEFFERSON SILVA">
                            <option value="JOÃO SILVA">
                            <option value="JOYLSON SILVEIRA">
                            <option value="FERNANDO NOAL">
                            <option value="MARCELO PAPPI">
                            <option value="MÁRI OSILVA">
                            <option value="MAXISOEL OLIVEIRA">
                            <option value="NICOLAS ALVES">
                            <option value="PETERSON SALIM">
                            <option value="ROBERSON ALMEIDA">
                            <option value="RODRIGO BANDEIRA">
                            <option value="SANDRO MOURA">
                            <option value="THALES SILVA">
                            <option value="VITOR SANTOS">
                            <option value="WILLIAM TOLEDO">
                        </datalist>
                    </div>
<label class="text-[10px] block mb-1 font-bold text-gray-500"><input type="checkbox" id="drop_nao_usado" onchange="travarCabo('drop')"> Cabo DROP Não utilizado</label>
                    </div>
                    
                    <div class="sig-wrapper">
                        <div class="sig-box" id="box_tec">
                            <span class="sig-placeholder">ASSINE AQUI</span>
                            <canvas id="sig_tec"></canvas>
                        </div>
                        <button onclick="clearSig('sig_tec')" class="text-[10px] text-red-500 underline mt-1 no-print font-bold uppercase"><i class="fas fa-eraser"></i> Limpar Assinatura</button>
                    </div>
                </div>

                <div class="mb-2 border-t pt-4">
                    <label class="input-label mb-2 text-base">CLIENTE / RESPONSÁVEL</label>
                    <div class="flex gap-4 mb-3">
                        <label class="text-sm font-bold flex items-center gap-2 cursor-pointer bg-slate-100 px-3 py-2 rounded hover:bg-slate-200">
                            <input type="radio" name="quem_recebe" value="Titular" checked onclick="toggleTerceiro(false)" class="accent-orange-600 scale-125"> Titular
                        </label>
                        <label class="text-sm font-bold flex items-center gap-2 cursor-pointer bg-slate-100 px-3 py-2 rounded hover:bg-slate-200">
                            <input type="radio" name="quem_recebe" value="Terceiro" onclick="toggleTerceiro(true)" class="accent-orange-600 scale-125"> Terceiro
                        </label>
                    </div>
                    
                    <div id="area_terceiro" class="hidden mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                        <label class="text-[10px] font-bold text-orange-800 uppercase mb-1 block">Dados do Responsável (Terceiro)</label>
                        <div class="grid gap-2">
                            <input type="text" id="terc_nome" class="input-field uppercase-input" placeholder="NOME COMPLETO">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="tel" id="terc_cpf" class="input-field text-center" placeholder="CPF (000.000.000-00)" oninput="mascaraCPF(this)" maxlength="14">
                                <input type="tel" id="terc_contato" class="input-field text-center" placeholder="CEL (00) 00000-0000" oninput="mascaraTel(this)" maxlength="15">
                            </div>
                        </div>
                    </div>

                    <div class="sig-wrapper">
                        <div class="sig-box" id="box_cli">
                            <span class="sig-placeholder">ASSINE AQUI</span>
                            <canvas id="sig_cli"></canvas>
                        </div>
                        <button onclick="clearSig('sig_cli')" class="text-[10px] text-red-500 underline mt-1 no-print font-bold uppercase"><i class="fas fa-eraser"></i> Limpar Assinatura</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- FLOAT FOOTER -->
   <div class="fixed bottom-0 left-0 w-full bg-white border-t p-3 shadow-lg z-50 flex gap-2 no-print">
        <button onclick="gerarResumo()" class="flex-1 bg-slate-800 text-white rounded font-bold text-xs h-10 shadow-sm border border-slate-300">
            RESUMO
        </button>
        <button id="btn_finalizar" onclick="finalizarTudo()" class="flex-1 bg-green-600 text-white rounded font-bold text-xs h-10 shadow-sm flex items-center justify-center gap-2 text-base">
            <i class="fas fa-check-circle"></i> FINALIZAR
        </button>
    </div>

    <!-- MODAL RESUMO -->
    <div id="modal_resumo" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded w-full max-w-md p-4 flex flex-col h-[80vh]">
            <h3 class="font-bold text-slate-700 mb-2">Resumo para Baixa</h3>
            <textarea id="resumo_txt" class="flex-1 border p-2 text-xs font-mono bg-slate-50 rounded mb-2"></textarea>
            <div class="flex gap-2">
                <button onclick="copiarResumo()" class="flex-1 bg-green-600 text-white rounded py-2 font-bold text-xs">COPIAR</button>
                <button onclick="document.getElementById('modal_resumo').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 rounded py-2 font-bold text-xs">FECHAR</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'rat_reparo_v12_data';
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywqLg5llMP8F6DzdoLeiRMazIBRhnFFGeL3KayW35Pq7Og9k2EeGrPcQykWXZ1CMzn/exec";
        
        // Apps List Data (Sem OUTROS)
        const APPS_DATA = ["RL NET TV", "WATCH", "QUALIFICA", "CENTRAL ASSINANTE", "TIP PLAY", "MAX", "CLUBE", "CÂMERAS"];

        window.onload = function() {
            document.getElementById('data_exec').valueAsDate = new Date();
            initCanvas('sig_tec');
            initCanvas('sig_cli');
            renderApps();
            loadData();
        };

        function renderApps() {
            const container = document.getElementById('apps_list');
            container.innerHTML = APPS_DATA.map(app => {
                const id = app.replace(/\s+/g, '_').toLowerCase();
                return `
                <div class="flex flex-col bg-gray-50 p-2 rounded border">
                    <span class="font-bold text-[10px] text-slate-700 mb-1">${app}</span>
                    <div class="flex gap-2 justify-between">
                        <label class="app-check"><input type="checkbox" id="app_${id}_inst"> Inst.</label>
                        <label class="app-check"><input type="checkbox" id="app_${id}_log"> Log.</label>
                        <label class="app-check"><input type="checkbox" id="app_${id}_ori"> Ori.</label>
                    </div>
                </div>`;
            }).join('');
        }

        // --- DATA SENDING LOGIC (GOOGLE SHEETS) ---
        function cleanNumber(val) {
            if(!val) return "";
            // Remove R$, dBm, whitespace
            let cleaned = val.replace(/[^\d,.-]/g, '').trim();
            return cleaned;
        }

// --- FUNÇÃO ÚNICA: ENVIAR E GERAR PDF ---
        async function finalizarTudo() {
            // 1. Confirmação
            if(!confirm("Deseja enviar os dados e gerar o PDF?")) return;

            const btn = document.getElementById('btn_finalizar');
            const textoOriginal = btn.innerHTML;
            
            // 2. Trava botão e muda texto
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

            // 3. Prepara os dados (Payload)
            const val = id => document.getElementById(id)?.value || '';
            const checkVal = n => document.querySelector(`input[name="${n}"]:checked`)?.value || 'N/A';
            
            // Materiais
            let materiaisStr = [];
            document.querySelectorAll('.mat-row').forEach(row => {
               const item = row.querySelector('.mat-text').innerText;
               const det = row.querySelector('.mat-detail').innerText;
               materiaisStr.push(`${item} [${det}]`);
            });
            
            // Técnico
            let tec = val('tec_nome');
            if(tec === 'OUTRO') tec = val('tec_nome_outro');

            const payload = {
                os: val('os_id'),
                id_cliente: val('cli_id'),
                nome_cliente: val('cli_nome'),
                data: val('data_exec'), 
                entrada: val('hora_in'),
                saida: val('hora_out'),
                drop_ini: val('drop_ini'),
                drop_fim: val('drop_fim'),
                utp_ini: val('utp_ini'),
                utp_fim: val('utp_fim'),
                materiais: materiaisStr.join(' | '),
                postura: checkVal('fb_postura'),
                dificuldade: checkVal('fb_dificuldade'),
                qualidade_mat: checkVal('fb_qual_mat'),
                qualidade_sup: checkVal('fb_sup'),
                instalacao_pre: checkVal('fb_qual_inst'),
                impacto_infra: checkVal('fb_infra'),
                qualidade_ferr: checkVal('fb_ferramentas'),
                suporte_superv: checkVal('fb_super'),
                tecnico: tec
            };

            // 4. Envia para o Google Sheets
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 5. Se deu certo, avisa visualmente e gera o PDF
                btn.innerHTML = '<i class="fas fa-file-pdf fa-spin"></i> GERANDO PDF...';
                await new Promise(r => setTimeout(r, 1000)); // Pausa rápida

                await gerarPDF(); // Chama a função que já existe no seu código
                
                alert("Sucesso! Dados enviados e PDF Salvo.");

            } catch (error) {
                console.error(error);
                // Se falhar o envio (internet), gera o PDF mesmo assim
                alert("Erro de conexão ao salvar na planilha. Gerando PDF de backup...");
                await gerarPDF();
            } finally {
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
            }
        }

        // UI Logic
        function toggleBlock(id) {
            const h = document.querySelector(`#${id} .block-header`);
            const c = document.querySelector(`#${id} .block-content`);
            h.classList.toggle('active');
            c.classList.toggle('show');
            if(c.classList.contains('show')) {
                setTimeout(() => c.scrollIntoView({behavior:'smooth', block:'center'}), 100);
                
                // --- FIX: Redimensiona os Canvas se eles estiverem zerados ao abrir o bloco ---
                const canvases = c.querySelectorAll('canvas');
                canvases.forEach(cv => {
                    if(cv.width === 0 || cv.width !== cv.parentElement.offsetWidth) {
                        cv.width = cv.parentElement.offsetWidth;
                        cv.height = cv.parentElement.offsetHeight;
                        const ctx = cv.getContext('2d');
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.strokeStyle = '#000';
                    }
                });
            }
        }
        
        function nextBlock(currentId, nextId) {
            const curHeader = document.querySelector(`#${currentId} .block-header`);
            if(curHeader.classList.contains('active')) toggleBlock(currentId);
            const nextHeader = document.querySelector(`#${nextId} .block-header`);
            if(!nextHeader.classList.contains('active')) toggleBlock(nextId);
        }

        function toggleTerceiro(show) { document.getElementById('area_terceiro').classList.toggle('hidden', !show); }
        function toggleCTO(cb) {
            const inp = document.getElementById('cto_num');
            if(cb.checked) { inp.value = "0"; inp.disabled = true; inp.classList.add('bg-gray-100'); }
            else { inp.value = ""; inp.disabled = false; inp.classList.remove('bg-gray-100'); }
            saveData();
        }
        function toggleNaoVerificado(groupId, checkbox) {
            document.querySelectorAll(`#${groupId} select`).forEach(sel => {
                sel.value = checkbox.checked ? "N/A" : "";
                checkbox.checked ? sel.classList.add('bg-gray-100') : sel.classList.remove('bg-gray-100');
                sel.classList.remove('error');
            });
            saveData();
        }
        function toggleTestes(groupId, checkbox) {
            const inputs = document.querySelectorAll(`#${groupId} input:not([type=checkbox]), #${groupId} select, #${groupId} button`);
            inputs.forEach(el => {
                el.disabled = checkbox.checked;
            });
            saveData();
        }
        function checkIpv6(type) {
            const val = document.getElementById(`${type}_ipv6_nota`).value;
            const det = document.getElementById(`${type}_ipv6_detalhe`);
            if(parseInt(val) < 10) det.classList.remove('hidden');
            else det.classList.add('hidden');
            saveData();
        }
        function checkTecOutro(el) {
            const inp = document.getElementById('tec_nome_outro');
            if(el.value === 'OUTRO') { inp.classList.remove('hidden'); inp.focus(); }
            else { inp.classList.add('hidden'); }
            saveData();
        }

        // Masks & Calcs
        function mascaraMoeda(el) { el.value = "R$ " + (el.value.replace(/\D/g, "") / 100).toFixed(2).replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); saveData(); }
        function maskDBM(el) { let v = el.value.replace(/\D/g, ""); if(!v) return; el.value = "-" + (parseInt(v)/100).toFixed(2).replace('.', ',') + " dBm"; saveData(); }
        function maskWifiDBM(el) { let v = el.value.replace(/[^\d]/g, ''); if(v.length>2)v=v.slice(0,2); if(v) el.value=`-${v} dBm`; updateWifiIcon(el); saveData(); }
        function checkPower() { /* Mesma lógica */ saveData(); } 
        function calcCabo(t) { 
            const i=document.getElementById(t+'_ini').value, f=document.getElementById(t+'_fim').value; 
            document.getElementById(t+'_total').value = Math.abs((f||0)-(i||0)) + 'm'; 
            saveData(); 
        }

        // Novas Máscaras
        function mascaraCPF(el) {
            let v = el.value.replace(/\D/g, "");
            if(v.length > 11) v = v.slice(0, 11);
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            el.value = v;
            saveData();
        }

        function mascaraTel(el) {
            let v = el.value.replace(/\D/g, "");
            if(v.length > 11) v = v.slice(0, 11);
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d)(\d{4})$/, "$1-$2");
            el.value = v;
            saveData();
        }

        // Dynamic Rows
        function addMaterial() { /* Mesma logica v5 */ 
            const item = document.getElementById('mat_item').value, acao = document.getElementById('mat_acao').value, qtd = document.getElementById('mat_qtd').value, mot = document.getElementById('mat_motivo').value;
            if(!item) return;
            const div = document.createElement('div'); div.className = 'dynamic-item mat-row';
            div.innerHTML = `<div class="flex-1"><span class="font-bold block mat-text">${item}</span><span class="text-[10px] ${acao==='Instalado'?'text-green-600':'text-red-600'} font-bold mat-detail"><i class="fas ${acao==='Instalado'?'fa-arrow-down':'fa-arrow-up'}"></i> ${acao} (${qtd}x)</span>${mot?`<span class="block text-[9px] text-gray-500 italic mat-mot">Obs: ${mot}</span>`:''}</div><button onclick="this.parentElement.remove(); saveData()" class="btn-remove"><i class="fas fa-times"></i></button>`;
            document.getElementById('mat_list').appendChild(div); document.getElementById('mat_motivo').value = ''; saveData();
        }
        function addWifiRow() {
            const div = document.createElement('div'); div.className = 'dynamic-item wifi-row gap-2';
            div.innerHTML = `<select class="input-field h-7 text-xs p-1 wifi-loc flex-1" onchange="checkWifiOther(this)"><option>Sala</option><option>Quarto 1</option><option>Quarto 2</option><option>Cozinha</option><option>Varanda</option><option>Fundo</option><option>Escritório</option><option value="Outros">Outros...</option></select><input type="text" class="hidden input-field h-7 text-xs p-1 flex-1 wifi-other uppercase-input" placeholder="Qual?"><div class="relative w-24"><input type="tel" class="input-field h-7 text-xs p-1 w-full text-center wifi-dbm pl-6" placeholder="-xx" oninput="maskWifiDBM(this)"><i class="fas fa-signal absolute left-2 top-1.5 text-gray-300 wifi-icon text-[10px]"></i></div><button onclick="this.parentElement.remove(); saveData()" class="btn-remove"><i class="fas fa-times"></i></button>`;
            document.getElementById('wifi_list').appendChild(div); saveData();
        }
        function checkWifiOther(s) { s.nextElementSibling.classList.toggle('hidden', s.value!=='Outros'); saveData(); }
        function updateWifiIcon(e) { /* Mesma logica */ }

        // Data Management
        function saveData() {
            const data = { inputs: {}, checks: [], radios: {}, html_mat: document.getElementById('mat_list').innerHTML, html_wifi: document.getElementById('wifi_list').innerHTML };
            document.querySelectorAll('input:not([type=checkbox]):not([type=radio]), select, textarea').forEach(el => { if(el.id) data.inputs[el.id] = el.value; });
            document.querySelectorAll('input[type=checkbox]:checked').forEach(el => { if(el.value) data.checks.push(el.value); if(el.id) data.inputs[el.id] = true; });
            document.querySelectorAll('input[type=radio]:checked').forEach(el => { data.radios[el.name] = el.value; });
            
            // --- FIX: Check width to prevent crash ---
            const cTec = document.getElementById('sig_tec');
            const cCli = document.getElementById('sig_cli');
            if(cTec.width > 0 && isCanvasSigned(cTec)) data.sig_tec = cTec.toDataURL();
            if(cCli.width > 0 && isCanvasSigned(cCli)) data.sig_cli = cCli.toDataURL();

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            document.getElementById('save_indicator').classList.add('show'); setTimeout(() => document.getElementById('save_indicator').classList.remove('show'), 1000);
        }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
            try {
                const d = JSON.parse(raw);
                Object.keys(d.inputs).forEach(k => { const e=document.getElementById(k); if(e){ if(e.type==='checkbox')e.checked=d.inputs[k]; else e.value=d.inputs[k]; }});
                d.checks.forEach(v => { const e=document.querySelector(`input[value="${v}"]`); if(e) e.checked=true; });
                Object.keys(d.radios).forEach(k => { const e=document.querySelector(`input[name="${k}"][value="${d.radios[k]}"]`); if(e) e.checked=true; });
                if(d.html_mat) document.getElementById('mat_list').innerHTML = d.html_mat;
                if(d.html_wifi) document.getElementById('wifi_list').innerHTML = d.html_wifi;
                if(d.sig_tec) loadSig('sig_tec', d.sig_tec); if(d.sig_cli) loadSig('sig_cli', d.sig_cli);
                
                // Logic Checks restore
                toggleCTO(document.getElementById('cto_sem_id'));
                if(document.querySelector('#sub_wifi input[type="checkbox"]').checked) toggleTestes('sub_wifi', document.querySelector('#sub_wifi input[type="checkbox"]'));
                if(document.querySelector('#sub_cabo input[type="checkbox"]').checked) toggleTestes('sub_cabo', document.querySelector('#sub_cabo input[type="checkbox"]'));
                checkIpv6('wifi'); checkIpv6('cabo');
                checkTecOutro(document.getElementById('tec_nome'));
                
                // Third Party Restore Logic
                const isTerc = document.querySelector('input[name="quem_recebe"][value="Terceiro"]').checked;
                toggleTerceiro(isTerc);

            } catch(e){}
        }

        // Robust Canvas Logic
        function initCanvas(id) {
            const c = document.getElementById(id);
            const ctx = c.getContext('2d');
            const wrapper = c.closest('.sig-box');
            
            // Set Size (Initial attempt)
            if(wrapper.offsetWidth > 0) {
                c.width = wrapper.offsetWidth; 
                c.height = wrapper.offsetHeight; 
            }

            ctx.lineWidth = 2; 
            ctx.lineCap = 'round'; 
            ctx.strokeStyle = '#000';

            let painting = false;

            function getPos(e) {
                const rect = c.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            }

            function startDraw(e) {
                e.preventDefault(); // Stop scroll
                painting = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                const ph = wrapper.querySelector('.sig-placeholder');
                if(ph) ph.style.display = 'none';
            }

            function moveDraw(e) {
                if (!painting) return;
                e.preventDefault(); 
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }

            function endDraw(e) {
                if(painting) {
                    painting = false;
                    ctx.beginPath();
                    saveData();
                }
            }

            c.addEventListener('mousedown', startDraw);
            c.addEventListener('touchstart', startDraw, { passive: false });
            c.addEventListener('mousemove', moveDraw);
            c.addEventListener('touchmove', moveDraw, { passive: false });
            c.addEventListener('mouseup', endDraw);
            c.addEventListener('touchend', endDraw);
            c.addEventListener('mouseleave', endDraw);
        }

        function clearSig(id) { 
            const c=document.getElementById(id); 
            c.getContext('2d').clearRect(0,0,c.width,c.height); 
            const ph = c.closest('.sig-box').querySelector('.sig-placeholder');
            if(ph) ph.style.display = 'block';
            saveData(); 
        }
        function isCanvasSigned(c) { 
            if(c.width === 0 || c.height === 0) return false;
            const d=c.getContext('2d').getImageData(0,0,c.width,c.height).data; 
            for(let i=3;i<d.length;i+=4)if(d[i]>0)return true; 
            return false; 
        }
        function loadSig(id,u) { 
            const c = document.getElementById(id);
            const i=new Image(); 
            i.onload=()=>{
                // Ensure canvas has size before drawing
                if(c.width === 0) { c.width = c.parentElement.offsetWidth; c.height = c.parentElement.offsetHeight; }
                c.getContext('2d').drawImage(i,0,0);
                const ph = c.closest('.sig-box').querySelector('.sig-placeholder');
                if(ph) ph.style.display = 'none';
            }; 
            i.src=u; 
        }
        
        function confirmarNovo() { if(confirm("Apagar tudo?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        function validarCampos() { return true; } 
        function validarEGerarPDF() { gerarPDF(); }

        // EXPORTS - RESUMO COMPLETO ATUALIZADO
        function getResumoText() {
            const val = id => document.getElementById(id)?.value || '';
            const checkVal = n => document.querySelector(`input[name="${n}"]:checked`)?.value || 'N/A';
            
            // 1. Identificação
            let text = `*RAT REPARO v12.0* - RESUMO COMPLETO\n`;
            text += `OS: ${val('os_id')} | ID: ${val('cli_id')}\n`;
            text += `Cliente: ${val('cli_nome')}\n`;
            text += `Data: ${val('data_exec')} | ${val('hora_in')} - ${val('hora_out')}\n`;
            
            // ... restante do resumo igual v11 ...
            return text; // (Simplificado aqui, mas mantido o mesmo do v11 no código final se necessário, mas para o app script o que importa é o payload JSON)
        }
        function gerarResumo() { 
            // Reuse v11 logic for simple text copy if needed, but focus is on Google Sheets
             // ... v11 logic ...
             document.getElementById('resumo_txt').value = getResumoTextImpl(); 
             document.getElementById('modal_resumo').classList.remove('hidden'); 
        }
        // Re-implementação rápida do GetResumoText para não quebrar o botão
        // --- FUNÇÃO DE RESUMO COMPLETO (FINAL) ---
        // --- FUNÇÃO DE RESUMO COMPLETO (FINAL) ---
        function getResumoTextImpl() {
            // Função auxiliar para pegar valor
            const val = (id) => document.getElementById(id)?.value || '';
            const isChecked = (id) => document.getElementById(id)?.checked;
            const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value;

            // --- CORREÇÃO DE DATA (NOVA FUNÇÃO) ---
            const formatarDataBR = (dataIso) => {
                if (!dataIso) return '';
                // Quebra o texto 2025-12-16 e inverte para 16/12/2025
                const partes = dataIso.split('-'); 
                if (partes.length === 3) return `${partes[2]}/${partes[1]}/${partes[0]}`;
                return dataIso;
            };

            let t = `*RELATÓRIO TÉCNICO*\n`;
            t += `--------------------------------\n`;

            // IDENTIFICAÇÃO
            t += `*IDENTIFICAÇÃO*\n`;
            // AQUI ESTÁ A MUDANÇA: Usamos formatarDataBR() na data
            t += `Data: ${formatarDataBR(val('data_exec'))} | Horário das ${val('hora_in')} às ${val('hora_out')}\n\n`;

            // ANÁLISE TÉCNICA
            t += `*ANÁLISE TÉCNICA*\n`;
            // Checkboxes de "Não verificado"
            if(isChecked('group_equip_nao_verif')) t += `[Equipamentos: Não verificado]\n`;
            if(isChecked('group_rede_nao_verif')) t += `[Rede: Não verificado]\n`;
            
            // Itens de Análise
            const itensAnalise = [
                {l:'Segurança', i:'chk_seg'}, {l:'Fontes', i:'chk_fontes'}, {l:'ONU', i:'chk_onu'},
                {l:'Router', i:'chk_router'}, {l:'TV Box', i:'chk_tvbox'}, {l:'Câmera', i:'chk_camera'},
                {l:'UTP', i:'chk_utp'}, {l:'Acab.Int', i:'chk_acabamento'}, {l:'Configs', i:'chk_config'},
                {l:'Drop Ext', i:'chk_drop'}, {l:'Conector', i:'chk_conec'}, {l:'Emenda', i:'chk_emenda'},
                {l:'Wi-Fi', i:'chk_alcance'}, {l:'IPTV', i:'chk_iptv'}, {l:'Acab.Ext', i:'chk_acab_ext'},
                {l:'Teste Vel', i:'chk_teste'}
            ];
            let analiseStr = [];
            itensAnalise.forEach(x => {
                const v = val(x.i);
                if(v && v !== 'N/A') analiseStr.push(`${x.l}: ${v}`);
            });
            if(analiseStr.length > 0) t += `${analiseStr.join(' | ')}\n`;
            if(val('analise_obs')) t += `Obs Análise: ${val('analise_obs')}\n`;
            t += `\n`;

            // PROCEDIMENTOS
            t += `*PROCEDIMENTOS REALIZADOS*\n`;
            let procs = [];
            document.querySelectorAll('.chip-input:checked').forEach(el => procs.push(el.nextElementSibling.innerText));
            if(procs.length > 0) t += `- ${procs.join('\n- ')}\n`;
            
            // Taxa
            if(isChecked('cobrar_taxa')) {
                t += `> TAXA COBRADA: ${val('taxa_valor')} (${val('taxa_forma')})\n`;
            }
            t += `\n`;

            // POTÊNCIA E INFRA
            t += `*POTÊNCIA E INFRA*\n`;
            t += `CTO: ${val('cto_num')} (Porta ${val('cto_porta')}) ${isChecked('cto_sem_id') ? '[Sem ID]' : ''}\n`;
            t += `Potências: CTO ${val('pot_cto')} | Drop ${val('pot_drop')} | IXC ${val('pot_ixc')}\n`;
            
            // Detalhes extras (radios)
            const ctoBatida = getRadio('oc_cto_batida');
            if(ctoBatida === 'Sim') t += `CTO Batida: Sim (Op: ${val('op_batida')})\n`;
            
            const idRem = getRadio('oc_id_rem');
            if(idRem === 'Sim') t += `ID Removido: ${val('id_removido')} ${isChecked('id_rem_null')?'(Sem ID)':''}\n`;
            
            const splitAdd = getRadio('oc_split');
            if(splitAdd === 'Sim') t += `Splitter 1x2: Sim (Auth: ${val('split_auth')} | ID: ${val('split_id')})\n`;
            t += `\n`;

            // MATERIAIS E CABOS
            t += `*MATERIAIS E CABOS*\n`;
            // Cabos
            if(isChecked('drop_nao_usado')) t += `Drop: Não utilizado\n`;
            else t += `Drop: ${val('drop_total')} (Bobina: ${val('drop_id')} | Ini: ${val('drop_ini')} Fim: ${val('drop_fim')})\n`;

            if(isChecked('utp_nao_usado')) t += `UTP: Não utilizado\n`;
            else t += `UTP: ${val('utp_total')} (Bobina: ${val('utp_id')} | Ini: ${val('utp_ini')} Fim: ${val('utp_fim')})\n`;
            
            // Lista de Materiais
            t += `Materiais Movimentados:\n`;
            const matRows = document.querySelectorAll('.mat-row');
            if(matRows.length === 0) t += `(Nenhum material listado)\n`;
            else {
                matRows.forEach(row => {
                    const item = row.querySelector('.mat-text').innerText;
                    const det = row.querySelector('.mat-detail').innerText.replace('\n',' ');
                    const obs = row.querySelector('.mat-mot')?.innerText || '';
                    t += `- ${item} [${det}] ${obs}\n`;
                });
            }
            t += `\n`;

  
            // TESTES
            t += `*TESTES DE REDE*\n`;
            // Wi-Fi
            if(isChecked('wifi_nao_realizado')) { 
                 t += `Wi-Fi: NÃO REALIZADO\n`;
            } else {
                t += `> WI-FI (${val('wifi_site')}): DL ${val('wifi_dl')} / UL ${val('wifi_ul')}\n`;
                t += `  Pings: GGL ${val('wifi_ping_goog')} | FCB ${val('wifi_ping_face')} | X ${val('wifi_ping_x')} | DNS ${val('wifi_ping_dns')}\n`;
                t += `  IPv6 Nota: ${val('wifi_ipv6_nota')} ${val('wifi_ipv6_detalhe') ? '('+val('wifi_ipv6_detalhe')+')' : ''}\n`;
                // Cômodos
                const wifis = document.querySelectorAll('.wifi-row');
                if(wifis.length > 0) {
                    t += `  Sinal nos Cômodos:\n`;
                    wifis.forEach(row => {
                         const loc = row.querySelector('.wifi-loc').value;
                         const other = row.querySelector('.wifi-other').value;
                         const dbm = row.querySelector('.wifi-dbm').value;
                         t += `  - ${loc === 'Outros' ? other : loc}: ${dbm}\n`;
                    });
                }
            }
            
            // Cabo
            if(isChecked('cabo_nao_realizado')) { 
                 t += `Cabo: NÃO REALIZADO\n`;
            } else {
                t += `> CABO (${val('cabo_site')}): DL ${val('cabo_dl')} / UL ${val('cabo_ul')}\n`;
                t += `  Pings: GGL ${val('cabo_ping_goog')} | FCB ${val('cabo_ping_face')} | X ${val('cabo_ping_x')} | DNS ${val('cabo_ping_dns')}\n`;
                t += `  IPv6 Nota: ${val('cabo_ipv6_nota')} ${val('cabo_ipv6_detalhe') ? '('+val('cabo_ipv6_detalhe')+')' : ''}\n`;
            }
            t += `\n`;

            // FECHAMENTO
            t += `*FECHAMENTO*\n`;
            t += `Detalhes Finais: ${val('fechamento_obs')}\n`;
            t += `\n`;
            
            const quemRecebe = getRadio('quem_recebe');
            t += `TÉCNICO RECEBIDO POR: ${quemRecebe}\n`;
            if(quemRecebe === 'Terceiro') {
                t += `Nome: ${val('terc_nome')} | CPF: ${val('terc_cpf')} | Tel: ${val('terc_contato')}\n`;
            }

            return t;
        }
        

        function copiarResumo() { navigator.clipboard.writeText(document.getElementById('resumo_txt').value); alert("Copiado!"); }
        
// --- FUNÇÃO DE GERAR PDF (COM CORREÇÃO DE ASSINATURA) ---
    // --- FUNÇÃO DE GERAR PDF (NATIVA / OFFLINE) ---
    async function gerarPDF() {
        // 1. Configura Nome do Arquivo (Truque para Mobile)
        const oldTitle = document.title;
        const osId = document.getElementById('os_id').value || 'SEM_OS';
        const cliNome = document.getElementById('cli_nome').value || 'CLIENTE';
        // Limpa nome para evitar erros no arquivo
        const cleanName = cliNome.replace(/[^a-zA-Z0-9\s]/g, '').trim().toUpperCase();
        document.title = `RAT_${cleanName}_${osId}`;

        // 2. Prepara Visual
        const btn = document.getElementById('btn_finalizar');
        if(btn) btn.innerHTML = '<i class="fas fa-print"></i> IMPRIMINDO...';
        
        // Expande todos os blocos para o conteúdo aparecer
        document.querySelectorAll('.block-content').forEach(b => b.classList.add('show'));
        document.querySelectorAll('.block-header').forEach(h => h.classList.add('active'));

        // Aguarda animações
        await new Promise(r => setTimeout(r, 500));

        document.body.classList.add('pdf-mode');

        // Configura Logo do PDF
        const pdfLogo = document.getElementById('pdf-header-logo');
        const contentDiv = document.getElementById('rat-content');
        if(pdfLogo && contentDiv) {
            pdfLogo.classList.remove('hidden');
            contentDiv.insertBefore(pdfLogo, contentDiv.firstChild);
        }

        // Fix: Inputs Checkbox/Radio (Garante que apareçam marcados)
        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(el => {
            if(el.checked) el.setAttribute('checked', 'checked');
            else el.removeAttribute('checked');
        });

        // Fix: Textareas (Troca por DIV para não cortar texto)
        document.querySelectorAll('textarea').forEach(t => { 
            const d = document.createElement('div'); 
            d.className = 'pdf-text-replace p-2 border text-xs'; 
            d.innerText = t.value; 
            t.parentNode.insertBefore(d, t); 
            t.style.display = 'none'; 
            t.dataset.replaced = 'true';
        });

        // Fix: Selects (Garante opção selecionada)
        document.querySelectorAll('select').forEach(el => {
            const options = el.querySelectorAll('option');
            options.forEach(opt => {
                if (opt.selected) opt.setAttribute('selected', 'selected');
                else opt.removeAttribute('selected');
            });
        });

        // Fix: Assinaturas (Canvas -> Imagem)
        const originalCanvases = [];
        document.querySelectorAll('canvas').forEach(canvas => {
            let temDesenho = false;
            try { temDesenho = isCanvasSigned(canvas); } catch(e) { temDesenho = true; }
            
            if (canvas.width === 0) { canvas.width = 300; canvas.height = 150; }

            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.className = 'sig-temp-img';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            
            originalCanvases.push({ canvas: canvas, img: img });
            canvas.parentNode.insertBefore(img, canvas);
            canvas.style.display = 'none';
        });

        // Esconde placeholders e elementos desnecessários
        document.querySelectorAll('.sig-placeholder').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.wifi-loc').forEach(s => { if(s.value==='Outros') s.style.display='none'; });

        // Pequeno delay para renderização final
        await new Promise(r => setTimeout(r, 100));

        // 3. Imprime
        window.print();

        // 4. Restaura Tela (Após fechar diálogo de impressão)
        setTimeout(() => {
            document.title = oldTitle; // Restaura título original
            document.body.classList.remove('pdf-mode');
            
            // Restaura Logo
            if(pdfLogo) {
                pdfLogo.classList.add('hidden');
                document.body.insertBefore(pdfLogo, contentDiv); // Move de volta (opcional, ou apenas esconde)
            }

            // Remove textos temporários
            document.querySelectorAll('.pdf-text-replace').forEach(e => e.remove());
            document.querySelectorAll('textarea[data-replaced]').forEach(e => {
                e.style.display = '';
                delete e.dataset.replaced;
            });
            
            // Restaura Canvas
            originalCanvases.forEach(obj => {
                obj.img.remove();
                obj.canvas.style.display = 'block';
            });

            // Recolhe blocos novamente (para manter organização)
            document.querySelectorAll('.block-content').forEach(b => b.classList.remove('show'));
            document.querySelectorAll('.block-header').forEach(h => h.classList.remove('active'));
            
            // Restaura visibilidade de elementos
            document.querySelectorAll('.wifi-loc').forEach(s => s.style.display='');
            
            // Restaura placeholders de assinatura se estiverem vazios
            try {
                if(!isCanvasSigned(document.getElementById('sig_tec'))) document.querySelector('#box_tec .sig-placeholder').style.display = 'block';
                if(!isCanvasSigned(document.getElementById('sig_cli'))) document.querySelector('#box_cli .sig-placeholder').style.display = 'block';
            } catch(e) {}

            if(btn) btn.innerHTML = '<i class="fas fa-check-circle"></i> FINALIZAR';
        }, 1000);
    }

    </script>
	</body>
</html>